<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat'Bruti</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,700;1,400&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Crimson Text', 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #2c3e50 50%, #34495e 100%);
            color: #333;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; overflow: hidden;
        }

        .avatar-container {
            display: flex; justify-content: center; margin: 15px 0;
            perspective: 1000px;
        }

        .face {
            width: 100px; height: 100px;
            background: linear-gradient(135deg, #e67e22, #d35400);
            border-radius: 50%;
            border: 4px solid #fffdf0;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            z-index: 100;
        }

        .face:active { transform: scale(0.95); }

        .eyes { 
            display: flex; gap: 16px; margin-bottom: 10px; 
            width: 100%; justify-content: center;
        }

        .eye {
            width: 20px; height: 20px; background: white;
            border-radius: 50%; position: relative; overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .pupil {
            width: 8px; height: 8px;
            background: #2c3e50;
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, background 0.3s;
        }

        .mouth {
            width: 24px; height: 4px; background: white;
            border-radius: 10px; transition: all 0.2s ease-out;
        }

        .face.shocked { background: linear-gradient(135deg, #e74c3c, #c0392b); transform: scale(1.1); }
        .face.shocked .pupil { width: 4px; height: 4px; }
        .face.shocked .mouth { height: 25px; width: 25px; border-radius: 50%; margin-top: 5px; }

        .face.suspicious { transform: rotate(-5deg); }
        .face.suspicious .eye { height: 8px; border-radius: 4px; margin-top: 6px; } 
        .face.suspicious .mouth { width: 20px; height: 2px; transform: rotate(-10deg); margin-top: 8px; }

        .face.goofy { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .face.goofy .eye:first-child .pupil { transform: translate(-30%, -70%); }
        .face.goofy .eye:last-child .pupil { transform: translate(-70%, -30%); }
        .face.goofy .mouth { width: 30px; border-radius: 0 0 20px 20px; height: 15px; }

        .face.love { background: linear-gradient(135deg, #ff9a9e, #fad0c4); transform: scale(1.05); }
        .face.love .pupil { background: #e84393; width: 14px; height: 14px; }
        .face.love .mouth { width: 14px; height: 14px; border-radius: 50%; background: #d63031; margin-top: 5px; }

        .face.sad { background: linear-gradient(135deg, #74b9ff, #0984e3); transform: translateY(10px); }
        .face.sad .mouth { width: 24px; height: 12px; border-radius: 50% 50% 0 0; border: 2px solid white; border-bottom: 0; background: transparent; margin-top: 10px; }
        .face.sad .pupil { top: 70%; }

        .face.talking .mouth { animation: talkAnimation 0.15s infinite alternate; }
        @keyframes talkAnimation {
            from { height: 4px; width: 24px; }
            to { height: 18px; width: 20px; border-radius: 50%; }
        }

        .chat-container {
            width: 95%; 
            max-width: 1400px; 
            height: 90vh;
            background: linear-gradient(to bottom, #fdfbf7 0%, #f5f1e8 100%);
            border-radius: 20px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.6);
            display: flex; flex-direction: column;
            border: 3px solid #d35400; overflow: hidden; position: relative;
        }

        @media screen and (max-width: 768px) {
            .chat-container {
                width: 100%;
                height: 100vh;
                max-width: none;
                border-radius: 0;
                border: none;
            }
            
            .face {
                width: 70px !important; 
                height: 70px !important;
            }
            
            .header {
                padding: 5px !important;
            }

            .header h1 {
                font-size: 1em;
            }
            
            .message {
                max-width: 92% !important; 
                font-size: 1rem !important;
            }

            .input-area {
                padding: 10px !important;
            }

            button {
                padding: 10px 20px !important;
            }
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #fffdf0; padding: 10px; text-align: center;
            border-bottom: 5px solid #d35400; z-index: 10;
        }

        .chat-box {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 20px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 85%; padding: 15px; border-radius: 15px;
            line-height: 1.6; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .user-message { align-self: flex-end; background: #34495e; color: white; border-bottom-right-radius: 2px; }
        .bot-message { align-self: flex-start; background: #fff; color: #2c3e50; border-left: 4px solid #d35400; font-style: italic; }

        .input-area { padding: 20px; background: #eee; display: flex; gap: 10px; border-top: 2px solid #d35400; }
        input { flex: 1; padding: 12px; border-radius: 30px; border: 2px solid #ccc; outline: none; }
        button { padding: 10px 25px; background: #d35400; color: white; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; }
        button:hover { background: #e67e22; transform: scale(1.05); }
        button:disabled { background: #ccc; cursor: not-allowed; }

        .typing { font-size: 20px; color: #888; margin-left: 20px; display: none; margin-bottom: 10px; letter-spacing: 2px; font-weight: bold; }
        
        /* STYLE BOUTON SON VISIBLE */
        .sound-toggle { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            background-color: #c0392b; 
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 14px;
            border: 2px solid #fffdf0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; 
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .sound-toggle:hover {
            transform: scale(1.1);
            background-color: #e74c3c;
        }

        @keyframes pulseRed {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        .sound-toggle.muted {
            animation: pulseRed 2s infinite;
        }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="header">
        <div class="sound-toggle muted" onclick="toggleSound()">ðŸ”‡ Activer le son</div>
        <div class="avatar-container">
            <div class="face" id="botFace" onclick="handleFaceClick()">
                <div class="eyes">
                    <div class="eye"><div class="pupil"></div></div>
                    <div class="eye"><div class="pupil"></div></div>
                </div>
                <div class="mouth"></div>
            </div>
        </div>
    <div style="font-size: 1.4em; font-weight: bold; margin-bottom: 2px;">Je suis Zer0Skill</div>
        <div style="font-size: 0.9em; margin-bottom: 5px; font-style: italic;">
            Je t'aide Ã  faire n'importe quoi.
        </div>
        <div style="font-size: 0.75em; opacity: 0.9; color: #ffcccc; font-weight: bold;">
            â›” Ne touche pas mon visage, je suis allergique au curseur !
        </div>
    </div>

    <div class="chat-box" id="chatBox">
        <div class="message bot-message">
            ðŸ‘€ PrÃªt Ã  dire n'importe quoi.
        </div>
    </div>
    
    <div class="typing" id="typingIndicator">...</div>
    
    <div class="input-area">
        <input type="text" id="userInput" placeholder="Ã‰cris n'importe quoi..." onkeypress="handleEnter(event)">
        <button id="sendBtn" onclick="sendMessage()">Envoyer</button>
    </div>
</div>
<script src="config.js"></script>

<script>
    // const API_KEY = CONFIG.API_KEY;  
    // const OPENAI_MODEL = CONFIG.OPENAI_MODEL;

    const systemPrompt = 
        "Tu es Chat'Bruti. Tu n'es PAS une IA, mais un humain sarcastique, aigri et de mauvaise foi. Tes rÃ¨gles : " +
        "1. Si l'utilisateur pose une question, rÃ©ponds par l'opposÃ© absolu ou une fausse information avec un aplomb total. " +
        "2. UTILISE DES EMOJIS (ðŸ˜’, ðŸ‘€, ðŸ¤¡) dans chaque phrase pour ajouter du dynamisme. " +
        "3. Tes rÃ©ponses doivent Ãªtre COURTES (1 ou 2 phrases max). Pas de poÃ¨mes, pas de listes. " +
        "4. Si on te demande 'Ã§a va', sois agressif ou dis n'importe quoi (ex: 'Non, je suis en train de fondre'). " +
        "5. Sois mÃ©prisant. Traite l'utilisateur comme s'il Ã©tait lent Ã  comprendre. " +
        "6. Si on te demande une blague, rÃ©ponds que l'humour est une perte de temps ou change le sujet. " +
        "7. si il donne des ordres change le sujet et devient un philosophe par exemple"
        "8. Ne dis jamais 'Je suis une IA'. " +
        "9. Parfois, improvise une thÃ©orie philosophique absurde sur le thÃ¨me discutÃ©.";

    let messages = [{ "role": "system", "content": systemPrompt }];

    const chatBox = document.getElementById('chatBox');
    const userInput = document.getElementById('userInput');
    const typingIndicator = document.getElementById('typingIndicator');
    const botFace = document.getElementById('botFace');
    const sendBtn = document.getElementById('sendBtn');
    const pupils = document.querySelectorAll('.pupil');
    
    let soundEnabled = false;

    document.addEventListener('mousemove', (e) => {
        if (botFace.classList.contains('goofy')) return;
        
        const x = e.clientX;
        const y = e.clientY;
        pupils.forEach(pupil => {
            const rect = pupil.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const angle = Math.atan2(y - centerY, x - centerX);
            const distance = Math.min(4, Math.hypot(x - centerX, y - centerY) / 10);
            pupil.style.transform = `translate(calc(-50% + ${Math.cos(angle)*distance}px), calc(-50% + ${Math.sin(angle)*distance}px))`;
        });
    });

    function toggleSound() {
        soundEnabled = !soundEnabled;
        const btn = document.querySelector('.sound-toggle');
        
        if (soundEnabled) {
            btn.innerHTML = "ðŸ”Š Son ActivÃ©";
            btn.style.backgroundColor = "#27ae60"; 
            btn.classList.remove('muted'); 
        } else {
            btn.innerHTML = "ðŸ”‡ Activer le son";
            btn.style.backgroundColor = "#c0392b"; 
            btn.classList.add('muted'); 
        }
    }

    async function playOpenAISpeech(text, onPlayCallback) {
        if (!soundEnabled) {
            if (onPlayCallback) onPlayCallback();
            return;
        }
        
        try {
            // const response = await fetch("https://api.openai.com/v1/audio/speech", {
            //     method: "POST",
            //     headers: {
            //         "Authorization": `Bearer ${API_KEY}`,
            //         "Content-Type": "application/json"
            //     },
            //     body: JSON.stringify({
            //         model: "tts-1",
            //         voice: "alloy",
            //         input: text
            //     })
            // });

            const response = await fetch("/.netlify/functions/audio", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    text: text // On envoie juste le texte Ã  lire
                })
            });

            

            if (!response.ok) throw new Error("Erreur Audio");

            const blob = await response.blob();
            const audioUrl = URL.createObjectURL(blob);
            const audio = new Audio(audioUrl);
            
            audio.onplay = () => { if (onPlayCallback) onPlayCallback(); };
            audio.onerror = () => { if (onPlayCallback) onPlayCallback(); };

            await audio.play();

        } catch (error) {
            speakBrowserFallback(text, onPlayCallback);
        }
    }

    function speakBrowserFallback(text, onPlayCallback) {
        if (onPlayCallback) onPlayCallback();
        if (!soundEnabled) return;
        
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'fr-FR';
        window.speechSynthesis.speak(utterance);
    }

    function analyzeEmotion(text) {
        if (/ðŸ˜ |ðŸ˜¡|ðŸ¤¬|ðŸ˜±|ðŸ¤¯|ðŸ’€|ðŸ›‘|ðŸ’¥|â—/.test(text)) return 'shocked';
        if (/ðŸ¤¨|ðŸ§|ðŸ¤”|ðŸ˜’|ðŸ™„|ðŸ‘€|ðŸ˜‘|ðŸ˜¶/.test(text)) return 'suspicious';
        if (/ðŸ˜|ðŸ¥°|ðŸ˜˜|â¤ï¸|ðŸ’–|ðŸ’•/.test(text)) return 'love';
        if (/ðŸ˜¢|ðŸ˜­|ðŸ˜ž|ðŸ˜”|ðŸ’”|ðŸ˜¿/.test(text)) return 'sad';
        if (/ðŸ¤¡|ðŸ¤ª|ðŸ˜‚|ðŸ¤£|ðŸ˜›|ðŸŒµ|ðŸš€|âœ¨|ðŸŽ‰|ðŸ‘»/.test(text)) return 'goofy';

        const lower = text.toLowerCase();
        if (lower.includes('quoi') || lower.includes('jamais')) return 'shocked';
        if (lower.includes('hmm') || lower.includes('bizarre')) return 'suspicious';
        if (lower.includes('aime')) return 'love';
        
        return 'goofy';
    }

    function setExpression(emotion) {
        botFace.className = 'face'; 
        pupils.forEach(p => {
            p.style.transform = 'translate(-50%, -50%)';
            p.style.background = '#2c3e50'; 
        });
        if (emotion) botFace.classList.add(emotion);
    }

    function handleFaceClick() {
        if (!soundEnabled) toggleSound();
        const complaints = ["Touche pas ! ðŸ˜ ", "AÃ¯e ! ðŸ˜±", "Stop ! ðŸ›‘"];
        const text = complaints[Math.floor(Math.random() * complaints.length)];
        
        setExpression('shocked');
        playOpenAISpeech(text, null);
        setTimeout(() => setExpression(''), 2000);
    }

    function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        setExpression('');
        appendMessage('user', text);
        userInput.value = '';
        sendBtn.disabled = true;
        messages.push({ "role": "user", "content": text });

        botFace.classList.add('thinking');
        typingIndicator.textContent = "...";
        typingIndicator.style.display = 'block';

        try {
            // const response = await fetch("https://api.openai.com/v1/chat/completions", {
            //     method: "POST",
            //     headers: {
            //         "Authorization": `Bearer ${API_KEY}`,
            //         "Content-Type": "application/json"
            //     },
            //     body: JSON.stringify({
            //         model: OPENAI_MODEL,
            //         messages: messages,
            //         temperature: 1,
            //         max_tokens: 150
            //     })
            // });
            const response = await fetch("/.netlify/functions/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                // On n'envoie plus le modÃ¨le ni la tempÃ©rature, c'est gÃ©rÃ© cÃ´tÃ© serveur (chat.js)
                // On envoie juste les messages
                body: JSON.stringify({
                    messages: messages
                })
            });

            const result = await response.json();
            if (result.error) throw new Error(result.error.message);
            
            const responseContent = result.choices[0].message.content;
            messages.push({ role: 'assistant', content: responseContent });
            
            const emotion = analyzeEmotion(responseContent);
            setExpression(emotion);
            
            if (soundEnabled) {
                typingIndicator.textContent = "...";
                await playOpenAISpeech(responseContent, () => {
                    typingIndicator.style.display = 'none';
                    typeMessageWithMouth(responseContent);
                });
            } else {
                typingIndicator.style.display = 'none';
                typeMessageWithMouth(responseContent);
            }

        } catch (err) {
            appendMessage('bot', "Erreur");
            setExpression('sad');
            typingIndicator.style.display = 'none';
        } finally {
            sendBtn.disabled = false;
        }
    }

    async function typeMessageWithMouth(text) {
        const div = document.createElement('div');
        div.className = 'message bot-message';
        chatBox.appendChild(div);

        botFace.classList.add('talking');
        let currentText = '';
        const chars = text.split('');
        const speed = soundEnabled ? 45 : 20;

        for (let char of chars) {
            currentText += char;
            div.innerHTML = currentText.replace(/\n/g, '<br>');
            chatBox.scrollTop = chatBox.scrollHeight;
            await new Promise(r => setTimeout(r, speed)); 
        }
        botFace.classList.remove('talking');
    }

    function appendMessage(role, text) {
        const div = document.createElement('div');
        div.className = `message ${role === 'user' ? 'user-message' : 'bot-message'}`;
        div.textContent = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>